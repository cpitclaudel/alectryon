\documentclass[a4paper]{article}
% generated by Docutils <http://docutils.sourceforge.net/>
% rubber: set program xelatex
\usepackage{fontspec}
% \defaultfontfeatures{Scale=MatchLowercase}
% straight double quotes (defined T1 but missing in TU):
\ifdefined \UnicodeEncodingName
  \DeclareTextCommand{\textquotedbl}{\UnicodeEncodingName}{%
    {\addfontfeatures{RawFeature=-tlig,Mapping=}\char34}}%
\fi
\usepackage{ifthen}
\usepackage{alltt}
\usepackage{color}
\setcounter{secnumdepth}{0}

%%% Custom LaTeX preamble

\setmainfont{Linux Libertine O}
\setsansfont{Linux Biolinum O}
\setmonofont[Scale=MatchLowercase]{Fira Code}

\usepackage{xeCJK}
\setCJKmainfont{Noto Sans CJK JP}
\setCJKsansfont{Noto Sans CJK JP}
\setCJKmonofont[Scale=0.9777]{Noto Sans CJK JP}

%%% User specified packages and stylesheets
\usepackage{alectryon}
\usepackage{pygments}

%%% Fallback definitions for Docutils-specific commands
% basic code highlight:
\providecommand*\DUrolecomment[1]{\textcolor[rgb]{0.40,0.40,0.40}{#1}}
\providecommand*\DUroledeleted[1]{\textcolor[rgb]{0.40,0.40,0.40}{#1}}
\providecommand*\DUrolekeyword[1]{\textbf{#1}}
\providecommand*\DUrolestring[1]{\textit{#1}}
% numeric or symbol footnotes with hyperlinks
\providecommand*{\DUfootnotemark}[3]{%
  \raisebox{1em}{\hypertarget{#1}{}}%
  \hyperlink{#2}{\textsuperscript{#3}}%
}
\providecommand{\DUfootnotetext}[4]{%
  \begingroup%
  \renewcommand{\thefootnote}{%
    \protect\raisebox{1em}{\protect\hypertarget{#1}{}}%
    \protect\hyperlink{#2}{#3}}%
  \footnotetext{#4}%
  \endgroup%
}

% inline markup (custom roles)
% \DUrole{#1}{#2} tries \DUrole#1{#2}
\providecommand*{\DUrole}[2]{%
  \ifcsname DUrole#1\endcsname%
    \csname DUrole#1\endcsname{#2}%
  \else
    % backwards compatibility: try \docutilsrole#1{#2}
    \ifcsname docutilsrole#1\endcsname%
      \PackageWarningNoLine{docutils}{Command prefix "docutilsrole" is
         deprecated, \MessageBreak use `\protect\DUrole #1`}
      \csname docutilsrole#1\endcsname{#2}%
    \else%
      #2%
    \fi%
  \fi%
}
% hyperlinks:
\ifthenelse{\isundefined{\hypersetup}}{
  \usepackage[colorlinks=true,linkcolor=blue,urlcolor=blue]{hyperref}
  \usepackage{bookmark}
  \urlstyle{same} % normal text font (alternatives: tt, rm, sf)
}{}
\hypersetup{
  pdftitle={Using the marker-placement mini-language},
}

\title{Using the marker-placement mini-language%
  \label{using-the-marker-placement-mini-language}}
\author{}
\date{}

%%% Body
\begin{document}
\maketitle

To compile:

\begin{quote}
\begin{alltt}
$ alectryon references.rst
    # ReST → HTML; produces ‘references.html’
$ DOCUTILSCONFIG=references.docutils.conf alectryon \textbackslash{}
    references.rst -o references.xe.tex --latex-dialect xelatex
    # ReST → HTML; produces ‘references.xe.tex’
\end{alltt}
\end{quote}


\section{Inserting numbered references%
  \label{inserting-numbered-references}%
}

Alectryon supports references to individual sentences and hypotheses within a code fragment.  The easiest way to reference a sentence is to use \texttt{:mref:`search-term`}.  Alectryon will search for that text and automatically add a label to the first matching sentence of the proof.  For example:

\begin{quote}
\begin{alectryon}
  \anchor{setup}
  \sep
  % Generator: Alectryon
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-fixpoint-plus-comm-0}\PY{k+kn}{Fixpoint}~\PY{n+nf}{plus\PYZus{}comm}~\PY{o}{(}\PY{n+nv}{n}~\PY{n+nv}{m}\PY{o}{:}~\PY{n}{nat}\PY{o}{)}~\PY{o}{\PYZob{}}\PY{n+nv}{struct}~\PY{n+nv}{n}\PY{o}{\PYZcb{}}~\PY{o}{:}~\PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}\PY{o}{.}\mrefmarker{1}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}
            \hyp{plus\char`\_comm}{\PY{k+kr}{forall}~\PY{n+nv}{n}~\PY{n+nv}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{,}~\PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}}
            \sep
            \hyp{n, m}{\PY{n}{nat}}
          \end{hyps}
          \sep
          \infrule{}
          \sep
          \begin{conclusion}
            \PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}
          \end{conclusion}
        \end{goal}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Proof}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}
            \hyp{plus\char`\_comm}{\PY{k+kr}{forall}~\PY{n+nv}{n}~\PY{n+nv}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{,}~\PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}}
            \sep
            \hyp{n, m}{\PY{n}{nat}}
          \end{hyps}
          \sep
          \infrule{}
          \sep
          \begin{conclusion}
            \PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}
          \end{conclusion}
        \end{goal}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-destruct-n-0}~~\PY{n+nb}{destruct}~\PY{n}{n}~\PY{n+nb}{eqn}\PY{o}{:}\PY{n}{Heq}\PY{o}{.}\mrefmarker{◉}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \anchor{references-rst-s-destruct-n-g-1-0}
          \sep
          \begin{hyps}
            \hyp{plus\char`\_comm}{\anchor{references-rst-s-destruct-n-g-1-h-plus-comm-0}\PY{k+kr}{forall}~\PY{n+nv}{n}~\PY{n+nv}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{,}~\PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}\mrefmarker{9}}
            \sep
            \hyp{n, m}{\anchor{references-rst-s-destruct-n-g-1-h-n-0}\PY{n}{nat}\mrefmarker{3}}
            \sep
            \hyp{Heq}{\anchor{references-rst-s-destruct-n-g-1-h-n-0-0}\PY{n}{n}~\PY{o}{=}~\PY{l+m+mi}{0}\mrefmarker{4}}
          \end{hyps}
          \sep
          \infrule{\mrefmarker{2}}
          \sep
          \begin{conclusion}
            \anchor{references-rst-s-destruct-n-ccl-0}\PY{l+m+mi}{0}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{l+m+mi}{0}\mrefmarker{5}
          \end{conclusion}
        \end{goal}
        \sep
        \begin{extragoals}
          \begin{goal}
            \anchor{references-rst-s-destruct-n-g-s-n0-0}
            \sep
            \begin{hyps}
              \hyp{plus\char`\_comm}{\PY{k+kr}{forall}~\PY{n+nv}{n}~\PY{n+nv}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{,}~\PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}}
              \sep
              \hyp{n, m, n0}{\PY{n}{nat}}
              \sep
              \hyp{Heq}{\anchor{references-rst-s-destruct-n-g-s-n0-h-n-s-0}\PY{n}{n}~\PY{o}{=}~\PY{n}{S}~\PY{n}{n0}\mrefmarker{7}}
            \end{hyps}
            \sep
            \infrule{\mrefmarker{6}}
            \sep
            \begin{conclusion}
              \anchor{references-rst-s-destruct-n-g-s-n0-ccl-0}\PY{n}{S}~\PY{n}{n0}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{S}~\PY{n}{n0}\mrefmarker{8}
            \end{conclusion}
          \end{goal}
        \end{extragoals}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-setup-s-base-case-0}~~\PY{o}{\PYZhy{}}~\PY{c}{(*~Base~case~*)}\mrefmarker{10}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}
            \hyp{plus\char`\_comm}{\PY{k+kr}{forall}~\PY{n+nv}{n}~\PY{n+nv}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{,}~\PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}}
            \sep
            \hyp{n, m}{\PY{n}{nat}}
            \sep
            \hyp{Heq}{\PY{n}{n}~\PY{o}{=}~\PY{l+m+mi}{0}}
          \end{hyps}
          \sep
          \infrule{}
          \sep
          \begin{conclusion}
            \PY{l+m+mi}{0}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{l+m+mi}{0}
          \end{conclusion}
        \end{goal}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      ~~~~\PY{n+nb}{rewrite}~\PY{o}{\PYZlt{}\PYZhy{}}~\PY{n}{plus\PYZus{}n\PYZus{}O}\PY{o}{;}~\PY{n+nb+bp}{reflexivity}\PY{o}{.}
    \end{input}
  \end{sentence}
\end{alectryon}

The \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{kn}{Fixpoint}}}}} command (\hyperref[references-rst-fixpoint-plus-comm-0]{1}) indicates that we are beginning an inductive proof.
\end{quote}

Optionally, the label can be picked manually, using \texttt{:mref:`label <target>`}:

\begin{quote}
The proof starts with a case analysis, indicated by “\hyperref[references-rst-destruct-n-0]{◉}”.
\end{quote}

Instead of whole sentences, is possible to refer to individual goals and hypotheses:

\begin{quote}
In the first case (\hyperref[references-rst-s-destruct-n-g-1-0]{2}), we see the variable \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{n}{n}}}}} in the context (\hyperref[references-rst-s-destruct-n-g-1-h-n-0]{3}), and we see that it is \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{mi}{0}}}}} (\hyperref[references-rst-s-destruct-n-g-1-h-n-0-0]{4}); notice how the conclusion of the first goal \hyperref[references-rst-s-destruct-n-ccl-0]{5} does not mention \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{n}{n}}}}} (it says \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{mi}{0}}}}} instead). In the second case \hyperref[references-rst-s-destruct-n-g-s-n0-0]{6}, we see that \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{n}{n}}}}} equals \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{n}{S} \DUrole{n}{n0}}}}} (\hyperref[references-rst-s-destruct-n-g-s-n0-h-n-s-0]{7}) and the conclusion (\hyperref[references-rst-s-destruct-n-g-s-n0-ccl-0]{8}) mentions \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{n}{S} \DUrole{n}{n0}}}}} instead of \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{mi}{0}}}}}.
\end{quote}

Note how the reference to a hypothesis of the second goal caused the whole hypothesis block to be unfolded (by default, hypotheses of secondary goals are folded).

As expected, referring multiple times to the same object creates a single marker, even using different references:

\begin{quote}
\begin{itemize}
\item \hyperref[references-rst-s-destruct-n-g-1-h-plus-comm-0]{9}

\item \hyperref[references-rst-s-destruct-n-g-1-h-plus-comm-0]{9}

\item \hyperref[references-rst-s-destruct-n-g-1-h-plus-comm-0]{9}

\item \hyperref[references-rst-s-destruct-n-g-1-h-plus-comm-0]{9}
\end{itemize}
\end{quote}

To allow forward- and back-references, counters are not reset from one block to the next:

\begin{quote}
\begin{alectryon}
  % Generator: Alectryon
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-induction-0}~~\PY{o}{\PYZhy{}}~\PY{c}{(*~Induction~*)}\mrefmarker{11}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}
            \hyp{plus\char`\_comm}{\PY{k+kr}{forall}~\PY{n+nv}{n}~\PY{n+nv}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{,}~\PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}}
            \sep
            \hyp{n, m, n0}{\PY{n}{nat}}
            \sep
            \hyp{Heq}{\PY{n}{n}~\PY{o}{=}~\PY{n}{S}~\PY{n}{n0}}
          \end{hyps}
          \sep
          \infrule{}
          \sep
          \begin{conclusion}
            \PY{n}{S}~\PY{n}{n0}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{S}~\PY{n}{n0}
          \end{conclusion}
        \end{goal}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      ~~~~\PY{n+nb}{simpl}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}
            \hyp{plus\char`\_comm}{\PY{k+kr}{forall}~\PY{n+nv}{n}~\PY{n+nv}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{,}~\PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}}
            \sep
            \hyp{n, m, n0}{\PY{n}{nat}}
            \sep
            \hyp{Heq}{\PY{n}{n}~\PY{o}{=}~\PY{n}{S}~\PY{n}{n0}}
          \end{hyps}
          \sep
          \infrule{}
          \sep
          \begin{conclusion}
            \PY{n}{S}~\PY{o}{(}\PY{n}{n0}~\PY{o}{+}~\PY{n}{m}\PY{o}{)}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{S}~\PY{n}{n0}
          \end{conclusion}
        \end{goal}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      ~~~~\PY{n+nb}{rewrite}~\PY{o}{(}\PY{n}{plus\PYZus{}comm}~\PY{n}{n0}\PY{o}{).}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}
            \hyp{plus\char`\_comm}{\PY{k+kr}{forall}~\PY{n+nv}{n}~\PY{n+nv}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{,}~\PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}}
            \sep
            \hyp{n, m, n0}{\PY{n}{nat}}
            \sep
            \hyp{Heq}{\PY{n}{n}~\PY{o}{=}~\PY{n}{S}~\PY{n}{n0}}
          \end{hyps}
          \sep
          \infrule{}
          \sep
          \begin{conclusion}
            \PY{n}{S}~\PY{o}{(}\PY{n}{m}~\PY{o}{+}~\PY{n}{n0}\PY{o}{)}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{S}~\PY{n}{n0}
          \end{conclusion}
        \end{goal}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      ~~~~\PY{n+nb}{rewrite}~\PY{n}{plus\PYZus{}n\PYZus{}Sm}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}
            \hyp{plus\char`\_comm}{\PY{k+kr}{forall}~\PY{n+nv}{n}~\PY{n+nv}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{,}~\PY{n}{n}~\PY{o}{+}~\PY{n}{m}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{n}}
            \sep
            \hyp{n, m, n0}{\PY{n}{nat}}
            \sep
            \hyp{Heq}{\PY{n}{n}~\PY{o}{=}~\PY{n}{S}~\PY{n}{n0}}
          \end{hyps}
          \sep
          \infrule{}
          \sep
          \begin{conclusion}
            \PY{n}{m}~\PY{o}{+}~\PY{n}{S}~\PY{n}{n0}~\PY{o}{=}~\PY{n}{m}~\PY{o}{+}~\PY{n}{S}~\PY{n}{n0}
          \end{conclusion}
        \end{goal}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      ~~~~\PY{n+nb+bp}{reflexivity}\PY{o}{.}\nl
    \end{input}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Qed}\PY{o}{.}
    \end{input}
  \end{sentence}
\end{alectryon}

\begin{itemize}
\item Bullets (\texttt{-}, \texttt{+}, \texttt{*}) delimit subproofs (\hyperref[references-rst-io-setup-s-base-case-0]{10}, \hyperref[references-rst-induction-0]{11})

\item It all started at \hyperref[references-rst-fixpoint-plus-comm-0]{1}
\end{itemize}
\end{quote}


\subsection{Defining custom counter styles%
  \label{defining-custom-counter-styles}%
}

Custom counter styles can be defined like using the \texttt{.. role::} directive and the \texttt{:counter-style:} option:

Here is how it looks:

\begin{quote}
The following commands print information about an identifier \hyperref[references-rst-io-cp-s-about-0]{α}, print its definition \hyperref[references-rst-io-cp-s-print-0]{β}, and compute the type of a term \hyperref[references-rst-io-cp-s-check-0]{γ} or its reduction \hyperref[references-rst-io-cp-s-compute-0]{δ}.

\begin{alectryon}
  \anchor{cp}
  \sep
  % Generator: Alectryon
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-cp-s-about-0}\PY{k+kn}{About}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}\PY{o}{.}\mrefmarker{α}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{o}{:}~\PY{n}{nat}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{nat}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{nat}\nl
          \nl
          \PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{k+kr}{is}~\PY{n}{not}~\PY{n}{universe}~\PY{n}{polymorphic}\nl
          \PY{k+kn}{Arguments}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{o}{(}\PY{n}{\PYZus{}}~\PY{n}{\PYZus{}}\PY{o}{)\PYZpc{}}\PY{n}{nat\PYZus{}scope}\nl
          \PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{k+kr}{is}~\PY{n}{transparent}\nl
          \PY{n}{Expands}~\PY{n}{to}\PY{o}{:}~\PY{n}{Constant}~\PY{n}{Coq}\PY{o}{.}\PY{n}{Init}\PY{o}{.}\PY{n}{Nat}\PY{o}{.}\PY{n}{add}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-cp-s-print-0}\PY{k+kn}{Print}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}\PY{o}{.}\mrefmarker{β}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{o}{=}~\nl
          \PY{k+kr}{fix}~\PY{n}{add}~\PY{o}{(}\PY{n}{n}~\PY{n}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{)}~\PY{o}{\PYZob{}}\PY{k+kr}{struct}~\PY{n}{n}\PY{o}{\PYZcb{}}~\PY{o}{:}~\PY{n}{nat}~\PY{o}{:=}\nl
          ~~\PY{k+kr}{match}~\PY{n}{n}~\PY{k+kr}{with}\nl
          ~~\PY{o}{|}~\PY{l+m+mi}{0}~\PY{o}{=\PYZgt{}}~\PY{n}{m}\nl
          ~~\PY{o}{|}~\PY{n}{S}~\PY{n}{p}~\PY{o}{=\PYZgt{}}~\PY{n}{S}~\PY{o}{(}\PY{n}{add}~\PY{n}{p}~\PY{n}{m}\PY{o}{)}\nl
          ~~\PY{k+kr}{end}\nl
          ~~~~~\PY{o}{:}~\PY{n}{nat}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{nat}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{nat}\nl
          \nl
          \PY{k+kn}{Arguments}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{o}{(}\PY{n}{\PYZus{}}~\PY{n}{\PYZus{}}\PY{o}{)\PYZpc{}}\PY{n}{nat\PYZus{}scope}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-cp-s-check-0}\PY{k+kn}{Check}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{l+m+mi}{2}~\PY{l+m+mi}{3}\PY{o}{.}\mrefmarker{γ}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{l+m+mi}{2}~\PY{o}{+}~\PY{l+m+mi}{3}\nl
          ~~~~~\PY{o}{:}~\PY{n}{nat}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-cp-s-compute-0}\PY{k+kn}{Compute}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{l+m+mi}{2}~\PY{l+m+mi}{3}\PY{o}{.}\mrefmarker{δ}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{o}{=}~\PY{l+m+mi}{5}\nl
          \PY{o}{:}~\PY{n}{nat}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
  \sep
  \begin{txt}
    \nl
  \end{txt}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-cp-s-simpl-0}\PY{k+kn}{Eval}~\PY{n+nb}{simpl}~\PY{k+kr}{in}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{l+m+mi}{2}~\PY{l+m+mi}{3}\PY{o}{.}\mrefmarker{い}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{o}{=}~\PY{l+m+mi}{5}\nl
          \PY{o}{:}~\PY{n}{nat}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-cp-s-cbn-0}\PY{k+kn}{Eval}~\PY{n+nb}{cbn}~\PY{k+kr}{in}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{l+m+mi}{2}~\PY{l+m+mi}{3}\PY{o}{.}\mrefmarker{ろ}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{o}{=}~\PY{l+m+mi}{5}\nl
          \PY{o}{:}~\PY{n}{nat}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-cp-s-cbv-0}\PY{k+kn}{Eval}~\PY{n+nb}{cbv}~\PY{k+kr}{in}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{l+m+mi}{2}~\PY{l+m+mi}{3}\PY{o}{.}\mrefmarker{は}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{o}{=}~\PY{l+m+mi}{5}\nl
          \PY{o}{:}~\PY{n}{nat}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-cp-s-lazy-0}\PY{k+kn}{Eval}~\PY{n+nb}{lazy}~\PY{k+kr}{in}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{l+m+mi}{2}~\PY{l+m+mi}{3}\PY{o}{.}\mrefmarker{に}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{o}{=}~\PY{l+m+mi}{5}\nl
          \PY{o}{:}~\PY{n}{nat}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-cp-s-vm-compute-0}\PY{k+kn}{Eval}~\PY{n+nb}{vm\PYZus{}compute}~\PY{k+kr}{in}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{l+m+mi}{2}~\PY{l+m+mi}{3}\PY{o}{.}\mrefmarker{ほ}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{o}{=}~\PY{l+m+mi}{5}\nl
          \PY{o}{:}~\PY{n}{nat}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-cp-s-pattern-0}\PY{k+kn}{Eval}~\PY{n+nb}{pattern}~\PY{l+m+mi}{2}~\PY{k+kr}{in}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{l+m+mi}{2}~\PY{l+m+mi}{3}\PY{o}{.}\mrefmarker{へ}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{o}{=}~\PY{o}{(}\PY{k+kr}{fun}~\PY{n+nv}{n}~\PY{o}{:}~\PY{n}{nat}~\PY{o}{=\PYZgt{}}~\PY{n}{n}~\PY{o}{+}~\PY{n}{S}~\PY{n}{n}\PY{o}{)}~\PY{l+m+mi}{2}\nl
          \PY{o}{:}~\PY{n}{nat}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
\end{alectryon}

The second batch of commands perform reduction with a custom strategy: \hyperref[references-rst-io-cp-s-simpl-0]{い} \hyperref[references-rst-io-cp-s-cbn-0]{ろ} \hyperref[references-rst-io-cp-s-cbv-0]{は} \hyperref[references-rst-io-cp-s-lazy-0]{に} \hyperref[references-rst-io-cp-s-vm-compute-0]{ほ} \hyperref[references-rst-io-cp-s-pattern-0]{へ}.
\end{quote}

Each inline reference is a link to the corresponding code fragment.


\section{Setting properties%
  \label{setting-properties}%
}

Objects located using the marker-placement mini-language can be tagged with arbitrary properties by appending a \texttt{{[}key{]}=val} annotation to the placement expression.  For example:

\begin{quote}
\begin{alectryon}
  % Generator: Alectryon
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Check}~\PY{n}{nat}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{n}{nat}\nl
          ~~~~~\PY{o}{:}~\PY{k+kt}{Set}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
\end{alectryon}
\end{quote}

These properties can then be used within custom transforms.  Out of the box, Alectryon only recognizes the \texttt{{[}lang{]}} annotation; if it is found, the corresponding code is highlighted using the Pygments lexer for that language.

\begin{quote}
\begin{alectryon}
  % Generator: Alectryon
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Extraction~Language~Haskell}\PY{o}{.}\nl
    \end{input}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Extraction}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{n+nf}{add}~\PY{o+ow}{::}~\PY{k+kt}{Nat}~\PY{o+ow}{\PYZhy{}\PYZgt{}}~\PY{k+kt}{Nat}~\PY{o+ow}{\PYZhy{}\PYZgt{}}~\PY{k+kt}{Nat}\nl
          \PY{n+nf}{add}~\PY{n}{n}~\PY{n}{m}~\PY{o+ow}{=}\nl
          ~~\PY{k+kr}{case}~\PY{n}{n}~\PY{k+kr}{of}~\PY{p}{\PYZob{}}\nl
          ~~~\PY{k+kt}{O}~\PY{o+ow}{\PYZhy{}\PYZgt{}}~\PY{n}{m}\PY{p}{;}\nl
          ~~~\PY{k+kt}{S}~\PY{n}{p}~\PY{o+ow}{\PYZhy{}\PYZgt{}}~\PY{k+kt}{S}~\PY{p}{(}\PY{n}{add}~\PY{n}{p}~\PY{n}{m}\PY{p}{)\PYZcb{}}\nl
          \nl
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
\end{alectryon}
\end{quote}


\section{Inserting textual references%
  \label{inserting-textual-references}%
}

Instead of inserting a link to the relevant goal fragment, you can use the \texttt{:mquote:} role to insert a copy of a goal fragment inline. This only works for an input sentence, the conclusion or name of a goal, and the type, body, or name of a hypothesis:

\begin{quote}
The proof above had two cases: \alectryonInline{\hyp{Heq}{\PY{n}{n}~\PY{o}{=}~\PY{l+m+mi}{0}\mrefmarker{4}}} and \alectryonInline{\hyp{Heq}{\PY{n}{n}~\PY{o}{=}~\PY{n}{S}~\PY{n}{n0}\mrefmarker{7}}}.
The second goal below is named \alectryonInline{gg}.
The last case of the proof below has two induction hypotheses: \alectryonInline{\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}}} and \alectryonInline{\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}\PYZsq{}}}. The two permutation hypotheses are \alectryonInline{H} and \alectryonInline{H0}.
\end{quote}

For conciseness, it is possible to define an alias of \texttt{:mquote:} that uses a fixed prefix.  Notice how the second example overrides the \texttt{.g} part of the prefix, too.

\begin{quote}
The proof above had two cases: \alectryonInline{\hyp{Heq}{\PY{n}{n}~\PY{o}{=}~\PY{l+m+mi}{0}\mrefmarker{4}}} and \alectryonInline{\hyp{Heq}{\PY{n}{n}~\PY{o}{=}~\PY{n}{S}~\PY{n}{n0}\mrefmarker{7}}}.
The second goal below is named \alectryonInline{gg}.
The last case of the proof below has two induction hypotheses: \alectryonInline{\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}}} and \alectryonInline{\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}\PYZsq{}}}.
The two permutation hypotheses are \alectryonInline{H} and \alectryonInline{H0}.
\end{quote}

Newlines in quoted objects are removed, and line breaks are allowed:

\begin{quote}
\begin{alectryon}
  % Generator: Alectryon
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Record}~\PY{n+nf}{P}~\PY{o}{\PYZob{}}\PY{n+nv}{A}~\PY{n+nv}{B}\PY{o}{:}~\PY{k+kt}{Type}\PY{o}{\PYZcb{}}~\PY{o}{:=}\nl
      ~~\PY{o}{\PYZob{}}~\PY{n}{p\PYZus{}first}\PY{o}{:}~\PY{n}{A}\PY{o}{;}\nl
      ~~~~\PY{n}{p\PYZus{}second}\PY{o}{:}~\PY{n}{B}~\PY{o}{\PYZcb{}.}\nl
    \end{input}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Goal}~\PY{k+kr}{forall}~\PY{o}{\PYZob{}}\PY{n+nv}{A}~\PY{n+nv}{B}\PY{o}{\PYZcb{}}~\PY{o}{(}\PY{n+nv}{p}\PY{o}{:}~\PY{o}{@}\PY{n}{P}~\PY{n}{A}~\PY{n}{B}\PY{o}{),}\nl
      ~~\PY{k+kr}{let}~\PY{n+nv}{a\PYZus{}first}~\PY{o}{:=}~\PY{n}{p}\PY{o}{.(}\PY{n}{p\PYZus{}first}\PY{o}{)}~\PY{k+kr}{in}\nl
      ~~\PY{k+kr}{let}~\PY{n+nv}{b\PYZus{}second}~\PY{o}{:=}~\PY{n}{p}\PY{o}{.(}\PY{n}{p\PYZus{}second}\PY{o}{)}~\PY{k+kr}{in}\nl
      ~~\PY{o}{\PYZob{}|}~\PY{n}{p\PYZus{}first}~\PY{o}{:=}~\PY{n}{a\PYZus{}first}\PY{o}{;}\nl
      ~~~~~\PY{n}{p\PYZus{}second}~\PY{o}{:=}~\PY{n}{b\PYZus{}second}~\PY{o}{|\PYZcb{}}~\PY{o}{=}~\PY{n}{p}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}\end{hyps}
          \sep
          \infrule{}
          \sep
          \begin{conclusion}
            \PY{k+kr}{forall}~\PY{o}{(}\PY{n+nv}{A}~\PY{n+nv}{B}~\PY{o}{:}~\PY{k+kt}{Type}\PY{o}{)}~\PY{o}{(}\PY{n+nv}{p}~\PY{o}{:}~\PY{n}{P}\PY{o}{),}\nl
            \PY{k+kr}{let}~\PY{n+nv}{a\PYZus{}first}~\PY{o}{:=}~\PY{n}{p\PYZus{}first}~\PY{n}{p}~\PY{k+kr}{in}\nl
            \PY{k+kr}{let}~\PY{n+nv}{b\PYZus{}second}~\PY{o}{:=}~\PY{n}{p\PYZus{}second}~\PY{n}{p}~\PY{k+kr}{in}\nl
            \PY{o}{\PYZob{}|}~\PY{n}{p\PYZus{}first}~\PY{o}{:=}~\PY{n}{a\PYZus{}first}\PY{o}{;}~\PY{n}{p\PYZus{}second}~\PY{o}{:=}~\PY{n}{b\PYZus{}second}~\PY{o}{|\PYZcb{}}~\PY{o}{=}~\PY{n}{p}
          \end{conclusion}
        \end{goal}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Proof}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}\end{hyps}
          \sep
          \infrule{}
          \sep
          \begin{conclusion}
            \PY{k+kr}{forall}~\PY{o}{(}\PY{n+nv}{A}~\PY{n+nv}{B}~\PY{o}{:}~\PY{k+kt}{Type}\PY{o}{)}~\PY{o}{(}\PY{n+nv}{p}~\PY{o}{:}~\PY{n}{P}\PY{o}{),}\nl
            \PY{k+kr}{let}~\PY{n+nv}{a\PYZus{}first}~\PY{o}{:=}~\PY{n}{p\PYZus{}first}~\PY{n}{p}~\PY{k+kr}{in}\nl
            \PY{k+kr}{let}~\PY{n+nv}{b\PYZus{}second}~\PY{o}{:=}~\PY{n}{p\PYZus{}second}~\PY{n}{p}~\PY{k+kr}{in}\nl
            \PY{o}{\PYZob{}|}~\PY{n}{p\PYZus{}first}~\PY{o}{:=}~\PY{n}{a\PYZus{}first}\PY{o}{;}~\PY{n}{p\PYZus{}second}~\PY{o}{:=}~\PY{n}{b\PYZus{}second}~\PY{o}{|\PYZcb{}}~\PY{o}{=}~\PY{n}{p}
          \end{conclusion}
        \end{goal}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \PY{n+nb}{destruct}~\PY{n}{p}\PY{o}{;}~\PY{n+nb+bp}{reflexivity}\PY{o}{.}~
    \end{input}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Qed}\PY{o}{.}
    \end{input}
  \end{sentence}
\end{alectryon}

The first sentence is \alectryonInline{\PY{k+kn}{Record}~\PY{n+nf}{P}~\PY{o}{\PYZob{}}\PY{n+nv}{A}~\PY{n+nv}{B}\PY{o}{:}~\PY{k+kt}{Type}\PY{o}{\PYZcb{}}~\PY{o}{:=}\nl
~~\PY{o}{\PYZob{}}~\PY{n}{p\PYZus{}first}\PY{o}{:}~\PY{n}{A}\PY{o}{;}\nl
~~~~\PY{n}{p\PYZus{}second}\PY{o}{:}~\PY{n}{B}~\PY{o}{\PYZcb{}.}}.\DUfootnotemark{id1}{f1}{1}
%
\DUfootnotetext{f1}{id1}{1}{\phantomsection\label{f1}%
The second sentence is \alectryonInline{\PY{k+kn}{Goal}~\PY{k+kr}{forall}~\PY{o}{\PYZob{}}\PY{n+nv}{A}~\PY{n+nv}{B}\PY{o}{\PYZcb{}}~\PY{o}{(}\PY{n+nv}{p}\PY{o}{:}~\PY{o}{@}\PY{n}{P}~\PY{n}{A}~\PY{n}{B}\PY{o}{),}\nl
~~\PY{k+kr}{let}~\PY{n+nv}{a\PYZus{}first}~\PY{o}{:=}~\PY{n}{p}\PY{o}{.(}\PY{n}{p\PYZus{}first}\PY{o}{)}~\PY{k+kr}{in}\nl
~~\PY{k+kr}{let}~\PY{n+nv}{b\PYZus{}second}~\PY{o}{:=}~\PY{n}{p}\PY{o}{.(}\PY{n}{p\PYZus{}second}\PY{o}{)}~\PY{k+kr}{in}\nl
~~\PY{o}{\PYZob{}|}~\PY{n}{p\PYZus{}first}~\PY{o}{:=}~\PY{n}{a\PYZus{}first}\PY{o}{;}\nl
~~~~~\PY{n}{p\PYZus{}second}~\PY{o}{:=}~\PY{n}{b\PYZus{}second}~\PY{o}{|\PYZcb{}}~\PY{o}{=}~\PY{n}{p}\PY{o}{.}}.  Later on we'll see a message: \alectryonInline{\begin{message}
  \PY{n}{Ignoring}~\PY{n}{implicit}~\PY{k+kn}{binder}~\PY{n}{declaration}~\PY{k+kr}{in}~\PY{n}{unexpected}~\PY{n}{position}\PY{o}{.}\nl
  \PY{o}{[}\PY{n}{unexpected}\PY{o}{\PYZhy{}}\PY{n}{implicit}\PY{o}{\PYZhy{}}\PY{n}{declaration}\PY{o}{,}\PY{n}{syntax}\PY{o}{]}
\end{message}}.
}
\end{quote}

To preserve newlines, use the \texttt{.. mquote::} directive instead:

\begin{quote}
\begin{alectryon}
  \PY{k+kn}{Goal}~\PY{k+kr}{forall}~\PY{o}{\PYZob{}}\PY{n+nv}{A}~\PY{n+nv}{B}\PY{o}{\PYZcb{}}~\PY{o}{(}\PY{n+nv}{p}\PY{o}{:}~\PY{o}{@}\PY{n}{P}~\PY{n}{A}~\PY{n}{B}\PY{o}{),}\nl
  ~~\PY{k+kr}{let}~\PY{n+nv}{a\PYZus{}first}~\PY{o}{:=}~\PY{n}{p}\PY{o}{.(}\PY{n}{p\PYZus{}first}\PY{o}{)}~\PY{k+kr}{in}\nl
  ~~\PY{k+kr}{let}~\PY{n+nv}{b\PYZus{}second}~\PY{o}{:=}~\PY{n}{p}\PY{o}{.(}\PY{n}{p\PYZus{}second}\PY{o}{)}~\PY{k+kr}{in}\nl
  ~~\PY{o}{\PYZob{}|}~\PY{n}{p\PYZus{}first}~\PY{o}{:=}~\PY{n}{a\PYZus{}first}\PY{o}{;}\nl
  ~~~~~\PY{n}{p\PYZus{}second}~\PY{o}{:=}~\PY{n}{b\PYZus{}second}~\PY{o}{|\PYZcb{}}~\PY{o}{=}~\PY{n}{p}\PY{o}{.}
\end{alectryon}

\begin{alectryon}
  \begin{message}
    \PY{n}{Ignoring}~\PY{n}{implicit}~\PY{k+kn}{binder}~\PY{n}{declaration}~\PY{k+kr}{in}~\PY{n}{unexpected}~\PY{n}{position}\PY{o}{.}\nl
    \PY{o}{[}\PY{n}{unexpected}\PY{o}{\PYZhy{}}\PY{n}{implicit}\PY{o}{\PYZhy{}}\PY{n}{declaration}\PY{o}{,}\PY{n}{syntax}\PY{o}{]}
  \end{message}
\end{alectryon}
\end{quote}

There, too, you may want to define aliases:

\begin{quote}
\begin{alectryon}
  \hyp{H}{\PY{n}{Permutation}~\PY{n}{l}~\PY{n}{l\PYZsq{}}}
\end{alectryon}

\begin{alectryon}
  \hyp{H0}{\PY{n}{Permutation}~\PY{n}{l\PYZsq{}}~\PY{n}{l\PYZsq{}\PYZsq{}}}
\end{alectryon}
\end{quote}

Finally, you may chose a different Pygments lexer to highlight a quote.  For example, here is a piece of Scheme code produced by \texttt{Extraction}:

\begin{quote}
\begin{alectryon}
  \begin{message}
    \PY{p}{(}\PY{k}{define~}\PY{n+nv}{add}~\PY{p}{(}\PY{n+nf}{lambdas}~\PY{p}{(}\PY{n+nf}{n}~\PY{n+nv}{m}\PY{p}{)}\nl
    ~~\PY{p}{(}\PY{n+nf}{match}~\PY{n+nv}{n}\nl
    ~~~~~\PY{p}{((}\PY{n+nf}{O}\PY{p}{)}~\PY{n+nv}{m}\PY{p}{)}\nl
    ~~~~~\PY{p}{((}\PY{n+nf}{S}~\PY{n+nv}{p}\PY{p}{)}~\PY{o}{`}\PY{p}{(}\PY{n+nf}{S}~\PY{o}{,}\PY{p}{(}\PY{n+nf}{@}~\PY{n+nv}{add}~\PY{n+nv}{p}~\PY{n+nv}{m}\PY{p}{))))))}\nl
    \nl
  \end{message}
\end{alectryon}
\end{quote}


\section{Customizing proof rendering (\textbf{experimental})%
  \label{customizing-proof-rendering-experimental}%
}

References can also be used to customize the display of goals and hypotheses.  In the following, hypotheses whose name start with \texttt{l} are omitted, and so are hypotheses named \texttt{a} and \texttt{A}.  After the call to \texttt{induction} (\hyperref[references-rst-io-pr-s-induction-1-0]{12}) the output is further limited to just goals 2 and 4, by excluding all goals and re-including only 2 and 4.  In goal 4, hypotheses whose type is exactly \texttt{list A} are shown, regardless of previous status, so \texttt{l}, \texttt{l'}, \texttt{l''} are visible (\hyperref[references-rst-io-pr-s-induction-1-g-4-h-l-0]{13}).  Finally, the \texttt{-.s(…).msg(…)} annotation reduces output for the second line (\texttt{Check …}) to include only the warning that it produces (and not its regular output); and the \texttt{-.s\{Proof.\}} annotation completely hides the \texttt{Proof.} line.

\begin{quote}
\begin{alectryon}
  \anchor{pr}
  \sep
  % Generator: Alectryon
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Check}~\PY{k+kr}{let}~\PY{n+nv}{t}~\PY{o}{:=}~\PY{n}{nat}~\PY{k+kr}{in}~\PY{k+kr}{forall}~\PY{o}{\PYZob{}}\PY{n+nv}{n}\PY{o}{:}~\PY{n}{t}\PY{o}{\PYZcb{},}~\PY{n}{n}~\PY{o}{\PYZgt{}=}~\PY{l+m+mi}{0}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{n}{Ignoring}~\PY{n}{implicit}~\PY{k+kn}{binder}~\PY{n}{declaration}~\PY{k+kr}{in}~\PY{n}{unexpected}~\PY{n}{position}\PY{o}{.}\nl
          \PY{o}{[}\PY{n}{unexpected}\PY{o}{\PYZhy{}}\PY{n}{implicit}\PY{o}{\PYZhy{}}\PY{n}{declaration}\PY{o}{,}\PY{n}{syntax}\PY{o}{]}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Theorem}~\PY{n+nf}{Permutation\PYZus{}In}~\PY{o}{\PYZob{}}\PY{n+nv}{A}\PY{o}{\PYZcb{}}~\PY{o}{(}\PY{n+nv}{l}~\PY{n+nv}{l\PYZsq{}}~\PY{o}{:}~\PY{n}{list}~\PY{n}{A}\PY{o}{)}~\PY{o}{(}\PY{n+nv}{a}\PY{o}{:}~\PY{n}{A}\PY{o}{)}~\PY{o}{:}\nl
      ~~\PY{n}{Permutation}~\PY{n}{l}~\PY{n}{l\PYZsq{}}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}\end{hyps}
          \sep
          \infrule{}
          \sep
          \begin{conclusion}
            \PY{n}{Permutation}~\PY{n}{l}~\PY{n}{l\PYZsq{}}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}}
          \end{conclusion}
        \end{goal}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \anchor{references-rst-io-pr-s-induction-1-0}~~\PY{n+nb}{induction}~\PY{l+m+mi}{1}\PY{o}{;}~\PY{n+nb}{intros}~\PY{o}{*}~\PY{n}{Hin}\PY{o}{;}~\PY{o}{[}~\PY{o}{|}~\PY{n+nb}{refine}~\PY{o}{?[}\PY{n}{gg}\PY{o}{]}~\PY{o}{|}~\PY{o}{..}~\PY{o}{].}\mrefmarker{12}
    \end{input}
    \sep
    \begin{output}
      \begin{goals}
        \begin{goal}
          \begin{hyps}
            \hyp{H}{\PY{n}{Permutation}~\PY{n}{l}~\PY{n}{l\PYZsq{}}}
            \sep
            \hyp{IHPermutation}{\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}}}
            \sep
            \hyp{Hin}{\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{o}{(}\PY{n}{x}~\PY{o}{::}~\PY{n}{l}\PY{o}{)}}
          \end{hyps}
          \sep
          \infrule{\gid{gg}}
          \sep
          \begin{conclusion}
            \PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{o}{(}\PY{n}{x}~\PY{o}{::}~\PY{n}{l\PYZsq{}}\PY{o}{)}
          \end{conclusion}
        \end{goal}
        \sep
        \begin{extragoals}
          \begin{goal}
            \begin{hyps}
              \hyp{l, l\char`\', l\char`\'\char`\'}{\anchor{references-rst-io-pr-s-induction-1-g-4-h-l-0}\PY{n}{list}~\PY{n}{A}\mrefmarker{13}}
              \sep
              \hyp{H}{\PY{n}{Permutation}~\PY{n}{l}~\PY{n}{l\PYZsq{}}}
              \sep
              \hyp{H0}{\PY{n}{Permutation}~\PY{n}{l\PYZsq{}}~\PY{n}{l\PYZsq{}\PYZsq{}}}
              \sep
              \hyp{IHPermutation1}{\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}}}
              \sep
              \hyp{IHPermutation2}{\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}\PYZsq{}}}
              \sep
              \hyp{Hin}{\PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l}}
            \end{hyps}
            \sep
            \infrule{}
            \sep
            \begin{conclusion}
              \PY{n}{List}\PY{o}{.}\PY{n}{In}~\PY{n}{a}~\PY{n}{l\PYZsq{}\PYZsq{}}
            \end{conclusion}
          \end{goal}
        \end{extragoals}
      \end{goals}
    \end{output}
  \end{sentence}
  \sep
  \begin{txt}
    \nl
  \end{txt}
  \sep
  \begin{sentence}
    \begin{input}
      ~~\PY{k+kp}{all}\PY{o}{:}~\PY{n+nb}{simpl}~\PY{k+kr}{in}~\PY{o}{*;}~\PY{n+nb+bp}{tauto}\PY{o}{.}\nl
    \end{input}
  \end{sentence}
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Qed}\PY{o}{.}
    \end{input}
  \end{sentence}
\end{alectryon}
\end{quote}


\section{Asserting properties of the output%
  \label{asserting-properties-of-the-output}%
}

A constant concern when displaying proof states to readers is that what is displayed to the user may go stale.  Alectryon mitigates the issue by automatically collecting proof states, but simply recording the prover's output doesn't fully solve the issue.  That is because the output of a command may change in an unexpected way, without raising an error.  For example, we may have written, with an early version of Coq:

\begin{quote}
\begin{alectryon}
  \anchor{plus}
  \sep
  % Generator: Alectryon
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Print}~\PY{n}{plus}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{k+kn}{Notation}~\PY{n+nf}{plus}~\PY{o}{:=}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
\end{alectryon}
\end{quote}

To show the recursive definition of addition.   But as Coq's standard library got reorganized, the definition of \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{n}{plus}}}}} changed to being an alias for \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{n}{Nat}\DUrole{o}{.}\DUrole{n}{add}}}}}, making the output of \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{kn}{Print} \DUrole{n}{plus}}}}} uninteresting.  In general, the recommended way to prevent this issue is by recording and versioning the prover's output using Alectryon caching facility (\texttt{--cache-directory}).  For small checks, however, Alectryon provides the \texttt{massert} directive, which checks that all references in its body resolve to a part of Coq's output.  For example, the following checks that \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{n}{plus}}}}} is indeed an alias and \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{n}{Nat}\DUrole{o}{.}\DUrole{n}{add}}}}} a \texttt{\DUrole{code}{\DUrole{highlight}{\DUrole{coq}{\DUrole{kn}{Fixpoint}}}}}.

\begin{quote}
\begin{alectryon}
  % Generator: Alectryon
  \sep
  \begin{sentence}
    \begin{input}
      \PY{k+kn}{Print}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}\PY{o}{.}
    \end{input}
    \sep
    \begin{output}
      \begin{messages}
        \begin{message}
          \PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{o}{=}~\nl
          \PY{k+kr}{fix}~\PY{n}{add}~\PY{o}{(}\PY{n}{n}~\PY{n}{m}~\PY{o}{:}~\PY{n}{nat}\PY{o}{)}~\PY{o}{\PYZob{}}\PY{k+kr}{struct}~\PY{n}{n}\PY{o}{\PYZcb{}}~\PY{o}{:}~\PY{n}{nat}~\PY{o}{:=}\nl
          ~~\PY{k+kr}{match}~\PY{n}{n}~\PY{k+kr}{with}\nl
          ~~\PY{o}{|}~\PY{l+m+mi}{0}~\PY{o}{=\PYZgt{}}~\PY{n}{m}\nl
          ~~\PY{o}{|}~\PY{n}{S}~\PY{n}{p}~\PY{o}{=\PYZgt{}}~\PY{n}{S}~\PY{o}{(}\PY{n}{add}~\PY{n}{p}~\PY{n}{m}\PY{o}{)}\nl
          ~~\PY{k+kr}{end}\nl
          ~~~~~\PY{o}{:}~\PY{n}{nat}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{nat}~\PY{o}{\PYZhy{}\PYZgt{}}~\PY{n}{nat}\nl
          \nl
          \PY{k+kn}{Arguments}~\PY{n}{Nat}\PY{o}{.}\PY{n}{add}~\PY{o}{(}\PY{n}{\PYZus{}}~\PY{n}{\PYZus{}}\PY{o}{)\PYZpc{}}\PY{n}{nat\PYZus{}scope}
        \end{message}
      \end{messages}
    \end{output}
  \end{sentence}
\end{alectryon}
\end{quote}

\end{document}
